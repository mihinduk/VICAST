#!/bin/bash
# VICAST Environment Configuration
# =================================
# This file sets up paths for VICAST tools and dependencies.
# Users should copy this to vicast_paths.local.env and customize for their system.
#
# Usage:
#   source vicast_paths.env
#
# Or for custom paths:
#   cp vicast_paths.env vicast_paths.local.env
#   # Edit vicast_paths.local.env with your paths
#   source vicast_paths.local.env

# =================================
# Conda Configuration
# =================================
# Path to conda installation
# Default: Looks for conda in common locations
if [ -z "$CONDA_BASE" ]; then
    if [ -f "/ref/sahlab/software/anaconda3/bin/activate" ]; then
        # HTCF default
        export CONDA_BASE="/ref/sahlab/software/anaconda3"
    elif [ -f "$HOME/anaconda3/bin/activate" ]; then
        # User home installation
        export CONDA_BASE="$HOME/anaconda3"
    elif [ -f "$HOME/miniconda3/bin/activate" ]; then
        # Miniconda installation
        export CONDA_BASE="$HOME/miniconda3"
    elif command -v conda &> /dev/null; then
        # Conda in PATH
        export CONDA_BASE="$(conda info --base)"
    else
        echo "WARNING: Conda not found. Please set CONDA_BASE environment variable."
        export CONDA_BASE=""
    fi
fi

# Conda activation command
if [ -n "$CONDA_BASE" ] && [ -f "$CONDA_BASE/bin/activate" ]; then
    export CONDA_ACTIVATE="source $CONDA_BASE/bin/activate"
else
    export CONDA_ACTIVATE="echo 'Conda not available'"
fi

# =================================
# SnpEff Configuration
# =================================
# Path to SnpEff installation
# Default: Uses VICAST's local installation or system installation
if [ -z "$SNPEFF_DIR" ]; then
    if [ -d "/ref/sahlab/software/snpEff" ]; then
        # HTCF default
        export SNPEFF_DIR="/ref/sahlab/software/snpEff"
    elif [ -d "$(dirname $(readlink -f $0))/../tools/snpEff" ]; then
        # VICAST local installation
        export SNPEFF_DIR="$(dirname $(readlink -f $0))/../tools/snpEff"
    elif [ -d "$HOME/snpEff" ]; then
        # User home installation
        export SNPEFF_DIR="$HOME/snpEff"
    else
        echo "WARNING: SnpEff not found. Run tools/setup_snpeff.sh to install."
        export SNPEFF_DIR=""
    fi
fi

# =================================
# Java Configuration
# =================================
# Path to Java installation (Java 21+ required for SnpEff)
if [ -z "$JAVA_HOME" ]; then
    if [ -d "/ref/sahlab/software/jdk-21.0.5+11" ]; then
        # HTCF default
        export JAVA_HOME="/ref/sahlab/software/jdk-21.0.5+11"
    elif command -v java &> /dev/null; then
        # Use system Java if available
        JAVA_PATH=$(command -v java)
        export JAVA_HOME="$(dirname $(dirname $(readlink -f $JAVA_PATH)))"
    else
        echo "WARNING: Java not found. Java 21+ required for SnpEff."
        export JAVA_HOME=""
    fi
fi

# =================================
# BLAST Database Configuration
# =================================
# Path to microbial contaminants BLAST database
if [ -z "$BLAST_DB" ]; then
    if [ -d "/ref/sahlab/data/microbes_db/microbial_contaminants" ]; then
        # HTCF default
        export BLAST_DB="/ref/sahlab/data/microbes_db/microbial_contaminants"
    elif [ -d "$HOME/blast_db/microbial_contaminants" ]; then
        # User home installation
        export BLAST_DB="$HOME/blast_db/microbial_contaminants"
    else
        echo "WARNING: BLAST database not found. Contamination screening will be skipped."
        export BLAST_DB=""
    fi
fi

# =================================
# Working Directory Configuration
# =================================
# Base directory for VICAST working files
if [ -z "$VICAST_WORK_DIR" ]; then
    if [ -d "/scratch/sahlab/$USER" ]; then
        # HTCF default (scratch space)
        export VICAST_WORK_DIR="/scratch/sahlab/$USER/vicast"
    else
        # Use current directory or home
        export VICAST_WORK_DIR="$PWD/vicast_work"
    fi
fi

# Create work directory if it doesn't exist
mkdir -p "$VICAST_WORK_DIR" 2>/dev/null || true

# =================================
# VICAST Installation Path
# =================================
# Path to VICAST installation (auto-detected)
if [ -z "$VICAST_DIR" ]; then
    # Try to detect VICAST directory from script location
    if [ -f "$0" ]; then
        export VICAST_DIR="$(cd "$(dirname "$0")" && pwd)"
    else
        export VICAST_DIR="$PWD"
    fi
fi

# =================================
# Summary
# =================================
if [ "$1" = "--verbose" ] || [ "$1" = "-v" ]; then
    echo "=========================================="
    echo "VICAST Environment Configuration"
    echo "=========================================="
    echo "CONDA_BASE:        $CONDA_BASE"
    echo "CONDA_ACTIVATE:    $CONDA_ACTIVATE"
    echo "SNPEFF_DIR:        $SNPEFF_DIR"
    echo "JAVA_HOME:         $JAVA_HOME"
    echo "BLAST_DB:          $BLAST_DB"
    echo "VICAST_WORK_DIR:   $VICAST_WORK_DIR"
    echo "VICAST_DIR:        $VICAST_DIR"
    echo "=========================================="
    echo ""
    echo "To customize these paths:"
    echo "  1. Copy vicast_paths.env to vicast_paths.local.env"
    echo "  2. Edit vicast_paths.local.env with your paths"
    echo "  3. Source the local version: source vicast_paths.local.env"
    echo ""
fi

# =================================
# Check for local overrides
# =================================
if [ -f "$(dirname $0)/vicast_paths.local.env" ]; then
    source "$(dirname $0)/vicast_paths.local.env"
fi
