# VICAST Example Workflow

This directory contains a minimal example demonstrating the VICAST pipeline using synthetic test data.

## Contents

```
examples/
├── README.md                    # This file
├── run_example.sh               # Main example script
├── data/                        # Input data
│   ├── test_virus.fasta         # Synthetic viral genome
│   ├── test_virus.gff3          # Gene annotations (GFF3 format)
│   ├── test_virus_annotations.tsv  # Annotation TSV (curated)
│   └── test_virus_variants.vcf  # Example variant calls
├── output/                      # Generated by run_example.sh
│   ├── converted_annotations.gff3
│   └── filtered_variants.tsv
└── expected_output/             # Reference outputs for verification
    ├── converted_annotations.gff3
    └── filtered_variants.tsv
```

## Quick Start

```bash
# Make sure VICAST is installed
pip install -e .

# Run the example workflow
cd examples
./run_example.sh

# Skip SnpEff integration (if not configured)
./run_example.sh --skip-snpeff
```

## What the Example Demonstrates

### 1. GFF Validation
Validates annotation files for SnpEff compatibility, checking:
- Proper GFF3 format
- Valid coordinates (start < end)
- Required attributes (ID, gene)
- No duplicate IDs

### 2. TSV to GFF Conversion
Converts curated annotation TSV files to proper GFF3 format with:
- Gene/mRNA/CDS hierarchy
- SnpEff-compatible attributes
- Support for KEEP/DELETE action flags

### 3. Variant Filtering
Parses VCF files and applies quality filters:
- Quality score threshold (default: 1000)
- Read depth threshold (default: 200)
- Allele frequency threshold (default: 0.10)

### 4. Summary Statistics
Generates summary of filtered variants including:
- Mean allele frequency
- Mean read depth
- Variant positions and effects

## Verifying Results

Compare your output to the expected results:

```bash
diff output/filtered_variants.tsv expected_output/filtered_variants.tsv
```

## Test Data Description

### test_virus.fasta
A synthetic 1,080 bp viral genome containing 4 genes.

### test_virus_annotations.tsv
Curated annotations with columns:
- `seqid`: Sequence accession
- `source`: Annotation source
- `type`: Feature type (CDS)
- `start/end`: Coordinates
- `strand`: +/-
- `gene_name`: Gene symbol
- `protein_id`: Protein accession
- `product`: Protein description
- `action`: KEEP or DELETE

### test_virus_variants.vcf
Example variant calls with:
- 5 SNPs at positions 50, 150, 320, 550, 700
- Varying quality scores (500-3000)
- Varying allele frequencies (0.05-0.50)
- DP4 strand-specific counts

## Full Pipeline Integration

For a complete workflow with SnpEff integration:

1. Configure SnpEff (see main README)
2. Add genome to SnpEff database:
   ```bash
   python vicast-annotate/step2_add_to_snpeff.py \
       examples/data/test_virus.fasta \
       examples/data/test_virus_annotations.tsv \
       --force
   ```
3. Run variant annotation:
   ```bash
   java -jar $SNPEFF_JAR NC_EXAMPLE.1 examples/data/test_virus_variants.vcf
   ```

## Troubleshooting

### "module 'vicast' not found"
Ensure VICAST is installed:
```bash
pip install -e .
```

### "SnpEff not configured"
Set the SNPEFF_HOME environment variable:
```bash
export SNPEFF_HOME=/path/to/snpEff
```
Or run with `--skip-snpeff` flag.
